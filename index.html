<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>画像合成＆色透過</title>
<style>
  body { font-family: sans-serif; }
  canvas { border: 1px solid #ccc; max-width: 100%; }
</style>
</head>
<body>
<h3>画像A（透過対象）</h3>
<input type="file" id="imgAInput" accept="image/*"><br>

<h3>画像B（背景）</h3>
<input type="file" id="imgBInput" accept="image/*"><br>

<h3>透過する色（カラーコード）</h3>
<input type="color" id="colorInput" value="#ffffff"><br><br>

<button id="mergeBtn">合成</button>
<button id="downloadBtn">ダウンロード</button>
<br><br>

<canvas id="canvas"></canvas>

<script>
const imgAInput = document.getElementById('imgAInput');
const imgBInput = document.getElementById('imgBInput');
const colorInput = document.getElementById('colorInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let imgA = new Image();
let imgB = new Image();

function loadImage(file, callback) {
  const url = URL.createObjectURL(file);
  const img = new Image();
  img.onload = () => {
    URL.revokeObjectURL(url);
    callback(img);
  };
  img.src = url;
}

document.getElementById('mergeBtn').onclick = () => {
  if (!imgAInput.files[0] || !imgBInput.files[0]) {
    alert("画像AとBを選択してください");
    return;
  }
  
  loadImage(imgBInput.files[0], (loadedB) => {
    imgB = loadedB;
    loadImage(imgAInput.files[0], (loadedA) => {
      imgA = loadedA;
      mergeImages();
    });
  });
};

function mergeImages() {
  canvas.width = imgB.width;
  canvas.height = imgB.height;
  
  // 背景Bを描画
  ctx.drawImage(imgB, 0, 0);
  
  // Aを描画
  ctx.drawImage(imgA, 0, 0);
  
  // 指定色を透過
  let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  let data = imgData.data;
  
  const targetColor = hexToRgb(colorInput.value);
  
  for (let i = 0; i < data.length; i += 4) {
    if (data[i] === targetColor.r &&
        data[i+1] === targetColor.g &&
        data[i+2] === targetColor.b) {
      data[i+3] = 0; // アルファ値を0に
    }
  }
  
  ctx.putImageData(imgData, 0, 0);
}

function hexToRgb(hex) {
  let bigint = parseInt(hex.slice(1), 16);
  let r = (bigint >> 16) & 255;
  let g = (bigint >> 8) & 255;
  let b = bigint & 255;
  return {r, g, b};
}

document.getElementById('downloadBtn').onclick = () => {
  const link = document.createElement('a');
  link.download = 'merged.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
};
</script>
</body>
</html>
